pipeline {
    agent {label 'georgeJavaNode01'}
	options {buildDiscarder logRotator(artifactDaysToKeepStr: '', artifactNumToKeepStr: '5', daysToKeepStr: '', numToKeepStr: '5')}
    stages {
        stage ('login ocp') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'msaocp', passwordVariable: 'password', usernameVariable: 'username')]){
               sh '''
                    oc login https://api.ocp49.redhat.poc:6443 -u $username -p $password
                    oc project nanshan
                '''
              }
            }
        }
        stage('clone from SCM') {
            steps {
                dir("/nanshanpoc") {
                sh 'rm -rf /nanshanpoc/msa-test-prod'
                sh 'git clone git@github.com:george-palsys/msa-test-prod.git'
                }
            }
			} 
			
        stage('Create product-v2 Application') { 
            steps {
               dir("/nanshanpoc/msa-test-prod") {
               sh 'git checkout main'
               sh './clean.sh  >/dev/null 2>&1'
               sh 'oc new-app java:openjdk-11-el7~https://github.com/george-palsys/msa-test-prod.git --context-dir=product --labels="app.kubernetes.io/part-of=msa-test-prod-git-app,app=product,version=v1" --name=product -n nanshan'
               }
                }
            }			

        stage('config product service') { 
            steps {
               dir("/nanshanpoc/msa-test-prod") {
               sh '''
	           git checkout main
                   oc delete svc product
                   oc apply -f ./svc.yaml
                '''
               }
                }
            }
        stage('deploy patch') { 
            steps {
               sh '''
                   oc patch deploy/product -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}'
                '''
                }
            }
			
      }
    }
